generator client {
  provider               = "prisma-client"
  output                 = "../src/generated/prisma"
  generatedFileExtension = "ts"
  importFileExtension    = "ts"
}

datasource db {
  provider = "postgresql"
}

model rate_configurations {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  rate_type       RateType
  value           Decimal   @db.Decimal(12, 6)
  source          String?
  effective_from  DateTime  @db.Timestamptz(6)
  effective_until DateTime? @db.Timestamptz(6)
  created_at      DateTime  @default(now()) @db.Timestamptz(6)
  updated_at      DateTime  @updatedAt @db.Timestamptz(6)
  created_by      String?   @db.Uuid
  is_active       Boolean   @default(true)

  @@unique([rate_type, effective_from])
  @@index([rate_type, effective_from, effective_until])
  @@index([rate_type, is_active])
}

model sub_cities {
  sub_city_id  String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name         String         @unique @db.VarChar(100)
  description  String?
  created_at   DateTime       @default(now())
  updated_at   DateTime       @updatedAt
  deleted_at   DateTime?
  is_deleted   Boolean        @default(false)
  land_parcels land_parcels[]
  users        users[]
}

model users {
  user_id       String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  username      String       @unique @db.VarChar(100)
  email         String?      @unique @db.VarChar(255)
  password_hash String
  full_name     String
  role          UserRole
  sub_city_id   String?      @db.Uuid
  created_at    DateTime     @default(now())
  updated_at    DateTime     @updatedAt
  last_login    DateTime?
  is_active     Boolean      @default(true)
  deleted_at    DateTime?
  is_deleted    Boolean      @default(false)
  audit_logs    audit_logs[]
  sub_city      sub_cities?  @relation(fields: [sub_city_id], references: [sub_city_id])
}

model configurations {
  config_id   String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  key         String          @unique @db.VarChar(100)
  value       Json
  category    ConfigCategory?
  description String?
  is_active   Boolean         @default(true)
  created_at  DateTime        @default(now())
  updated_at  DateTime        @updatedAt
  deleted_at  DateTime?
  is_deleted  Boolean         @default(false)
}

model audit_logs {
  log_id      String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id     String      @db.Uuid
  action_type AuditAction
  entity_type String
  entity_id   String
  changes     Json?
  timestamp   DateTime    @default(now())
  ip_address  String?
  user        users       @relation(fields: [user_id], references: [user_id])
}

model land_parcels {
  upin             String                   @id @db.VarChar(50)
  file_number      String                   @unique @db.VarChar(100)
  tabia            String                   @db.VarChar(100)
  ketena           String                   @db.VarChar(50)
  block            String                   @db.VarChar(50)
  total_area_m2    Decimal                  @db.Decimal(12, 2)
  land_use         String?
  created_at       DateTime                 @default(now())
  updated_at       DateTime                 @updatedAt
  deleted_at       DateTime?
  is_deleted       Boolean                  @default(false)
  land_grade       Decimal                  @db.Decimal(10, 2)
  sub_city_id      String                   @db.Uuid
  tenure_type      String                   @default("OLD_POSSESSION")
  boundary_coords  Json?
  boundary_east    String?                  @db.VarChar(255)
  boundary_north   String?                  @db.VarChar(255)
  boundary_south   String?                  @db.VarChar(255)
  boundary_west    String?                  @db.VarChar(255)
  parent_upin      String?                  @db.VarChar(50)
  status           ParcelStatus             @default(ACTIVE)
  billing_records  billing_records[]
  buildings        building_details[]
  documents        documents[]
  encumbrances     encumbrances[]
  transactions     financial_transactions[]
  parent_parcel    land_parcels?            @relation("ParcelLineage", fields: [parent_upin], references: [upin])
  child_parcels    land_parcels[]           @relation("ParcelLineage")
  sub_city         sub_cities               @relation(fields: [sub_city_id], references: [sub_city_id])
  lease_agreement  lease_agreements?
  order_bill_items order_bill_items[]
  history          ownership_history[]
  owners           parcel_owners[]
  valuations       tax_valuation_roll[]

  @@index([sub_city_id, tabia])
  @@index([status])
}

model owners {
  owner_id         String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  full_name        String
  national_id      String              @unique @db.VarChar(50)
  tin_number       String?             @unique @db.VarChar(50)
  phone_number     String
  created_at       DateTime?           @default(now())
  updated_at       DateTime?           @updatedAt
  deleted_at       DateTime?
  is_deleted       Boolean             @default(false)
  documents        documents[]
  transferred_from ownership_history[] @relation("OwnershipHistoryFrom")
  transferred_to   ownership_history[] @relation("OwnershipHistoryTo")
  parcels          parcel_owners[]
}

model parcel_owners {
  upin            String       @db.VarChar(50)
  owner_id        String       @db.Uuid
  created_at      DateTime     @default(now())
  updated_at      DateTime     @updatedAt
  acquired_at     DateTime     @default(now())
  is_active       Boolean      @default(true)
  retired_at      DateTime?
  parcel_owner_id String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  deleted_at      DateTime?
  is_deleted      Boolean      @default(false)
  owner           owners       @relation(fields: [owner_id], references: [owner_id], onDelete: Cascade)
  parcel          land_parcels @relation(fields: [upin], references: [upin], onDelete: Cascade)

  @@unique([upin, owner_id, acquired_at])
}

model ownership_history {
  history_id     String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  upin           String
  event_snapshot Json
  transfer_date  DateTime     @default(now())
  created_at     DateTime     @default(now())
  updated_at     DateTime?    @updatedAt
  from_owner_id  String?      @db.Uuid
  reference_no   String?      @unique
  to_owner_id    String?      @db.Uuid
  transfer_price Decimal?     @db.Decimal(18, 2)
  deleted_at     DateTime?
  is_deleted     Boolean      @default(false)
  transfer_type  String
  documents      documents[]
  from_owner     owners?      @relation("OwnershipHistoryFrom", fields: [from_owner_id], references: [owner_id])
  to_owner       owners?      @relation("OwnershipHistoryTo", fields: [to_owner_id], references: [owner_id])
  parcel         land_parcels @relation(fields: [upin], references: [upin])

  @@index([upin])
}

model lease_agreements {
  lease_id            String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  upin                String            @unique @db.VarChar(50)
  annual_lease_fee    Decimal?          @db.Decimal(18, 2)
  total_lease_amount  Decimal           @db.Decimal(18, 2)
  start_date          DateTime          @db.Date
  expiry_date         DateTime?         @db.Date
  annual_installment  Decimal           @db.Decimal(18, 2)
  contract_date       DateTime          @db.Date
  created_at          DateTime          @default(now())
  down_payment_amount Decimal           @db.Decimal(18, 2)
  lease_period_years  Int
  legal_framework     String
  payment_term_years  Int
  price_per_m2        Decimal           @db.Decimal(18, 2)
  updated_at          DateTime?         @updatedAt
  deleted_at          DateTime?
  is_deleted          Boolean           @default(false)
  interest_rate       Decimal?          @db.Decimal(5, 4)
  status              LeaseStatus       @default(ACTIVE)
  billing_records     billing_records[]
  documents           documents[]
  land_parcel         land_parcels      @relation(fields: [upin], references: [upin])
}

model building_details {
  building_id String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  upin        String       @db.VarChar(50)
  usage_type  String?
  total_area  Decimal      @db.Decimal(12, 2)
  floor_count Int          @default(0)
  created_at  DateTime     @default(now())
  updated_at  DateTime?    @updatedAt
  deleted_at  DateTime?
  is_deleted  Boolean      @default(false)
  parcel      land_parcels @relation(fields: [upin], references: [upin])
}

model billing_records {
  bill_id            String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  upin               String             @db.VarChar(50)
  fiscal_year        Int
  amount_due         Decimal            @db.Decimal(18, 2)
  penalty_amount     Decimal?           @default(0) @db.Decimal(18, 2)
  payment_status     PaymentStatus      @default(UNPAID)
  created_at         DateTime           @default(now())
  updated_at         DateTime?          @updatedAt
  deleted_at         DateTime?
  is_deleted         Boolean            @default(false)
  due_date           DateTime?
  interest_amount    Decimal            @default(0) @db.Decimal(18, 2)
  bill_type          String
  interest_rate_used Decimal?           @db.Decimal(5, 4)
  lease_id           String?            @db.Uuid
  penalty_rate_used  Decimal?           @db.Decimal(10, 4)
  sync_status        SyncStatus?        @default(PENDING)
  installment_number Int?
  base_payment       Decimal?           @db.Decimal(18, 2)
  remaining_amount   Decimal?           @default(0) @db.Decimal(18, 2)
  last_payment_date  DateTime?
  lease_agreement    lease_agreements?  @relation(fields: [lease_id], references: [lease_id])
  parcel             land_parcels       @relation(fields: [upin], references: [upin])
  order_bill_items   order_bill_items[]

  @@unique([upin, lease_id, fiscal_year, bill_type, installment_number])
  @@index([fiscal_year])
  @@index([payment_status])
  @@index([upin, fiscal_year])
  @@index([due_date])
}

model financial_transactions {
  transaction_id      String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  upin                String          @db.VarChar(50)
  receipt_serial_no   String          @unique
  amount_paid         Decimal         @db.Decimal(18, 2)
  payment_date        DateTime        @default(now())
  created_at          DateTime        @default(now())
  updated_at          DateTime?       @updatedAt
  deleted_at          DateTime?
  is_deleted          Boolean         @default(false)
  bank_transaction_id String?
  payment_method      String
  revenue_type        String
  bank_branch         String?
  bank_account        String?
  notes               String?
  order_number        String?         @db.VarChar(50)
  recorded_at         DateTime        @default(now())
  transaction_type    String          @default("PAYMENT")
  payment_orders      payment_orders? @relation(fields: [order_number], references: [order_number])
  parcel              land_parcels    @relation(fields: [upin], references: [upin])

  @@index([bank_transaction_id])
  @@index([order_number])
  @@index([payment_date])
  @@index([receipt_serial_no])
  @@index([upin, payment_date])
}

model encumbrances {
  encumbrance_id    String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  upin              String            @db.VarChar(50)
  issuing_entity    String
  reference_number  String?
  status            EncumbranceStatus @default(ACTIVE)
  registration_date DateTime          @default(now())
  created_at        DateTime          @default(now())
  updated_at        DateTime?         @updatedAt
  deleted_at        DateTime?
  is_deleted        Boolean           @default(false)
  type              String
  documents         documents[]
  land_parcel       land_parcels      @relation(fields: [upin], references: [upin], onDelete: Cascade)
}

model tax_valuation_roll {
  valuation_id   String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  upin           String       @db.VarChar(50)
  taxable_value  Decimal      @db.Decimal(18, 2)
  appraisal_date DateTime     @default(now())
  expiry_date    DateTime
  created_at     DateTime     @default(now())
  updated_at     DateTime?    @updatedAt
  deleted_at     DateTime?
  is_deleted     Boolean      @default(false)
  parcel         land_parcels @relation(fields: [upin], references: [upin])
}

model documents {
  doc_id         String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  upin           String?            @db.VarChar(50)
  owner_id       String?            @db.Uuid
  file_url       String
  file_name      String
  is_verified    Boolean            @default(false)
  upload_date    DateTime           @default(now())
  created_at     DateTime           @default(now())
  updated_at     DateTime?          @updatedAt
  lease_id       String?            @db.Uuid
  history_id     String?            @db.Uuid
  encumbrance_id String?            @db.Uuid
  deleted_at     DateTime?
  is_deleted     Boolean            @default(false)
  doc_type       String
  encumbrance    encumbrances?      @relation(fields: [encumbrance_id], references: [encumbrance_id], onDelete: Cascade)
  history        ownership_history? @relation(fields: [history_id], references: [history_id], onDelete: Cascade)
  lease          lease_agreements?  @relation(fields: [lease_id], references: [lease_id], onDelete: Cascade)
  owner          owners?            @relation(fields: [owner_id], references: [owner_id], onDelete: Cascade)
  parcel         land_parcels?      @relation(fields: [upin], references: [upin], onDelete: Cascade)
}

model order_bill_items {
  id              String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  order_number    String          @db.VarChar(50)
  bill_id         String          @db.Uuid
  upin            String          @db.VarChar(50)
  bill_type       String
  amount          Decimal         @db.Decimal(18, 2)
  created_at      DateTime        @default(now())
  updated_at      DateTime?
  fiscal_year     Int
  billing_records billing_records @relation(fields: [bill_id], references: [bill_id], onDelete: Cascade)
  payment_orders  payment_orders  @relation(fields: [order_number], references: [order_number], onDelete: Cascade)
  land_parcels    land_parcels    @relation(fields: [upin], references: [upin])

  @@unique([order_number, bill_id])
  @@unique([order_number, upin, bill_type])
  @@index([bill_id])
  @@index([bill_type])
  @@index([fiscal_year])
  @@index([order_number])
  @@index([upin])
}

model payment_orders {
  order_number             String                   @id @db.VarChar(50)
  generated_at             DateTime                 @default(now())
  expires_at               DateTime
  status                   OrderStatus              @default(GENERATED)
  generation_mode          OrderGenerationMode      @default(AUTO)
  paid_at                  DateTime?
  cancelled_at             DateTime?
  payment_method           String?
  final_amount_paid        Decimal?                 @db.Decimal(18, 2)
  created_at               DateTime                 @default(now())
  updated_at               DateTime?
  deleted_at               DateTime?
  is_deleted               Boolean                  @default(false)
  total_amount             Decimal                  @db.Decimal(18, 2)
  current_calculated_total Decimal?                 @db.Decimal(18, 2)
  last_recalculated_at     DateTime?
  financial_transactions   financial_transactions[]
  order_bill_items         order_bill_items[]

  @@index([expires_at])
  @@index([generated_at])
  @@index([status])
}

enum UserRole {
  CITY_ADMIN
  SUBCITY_NORMAL
  SUBCITY_AUDITOR
  REVENUE_ADMIN
  REVENUE_USER
  SUBCITY_ADMIN
}

enum RateType {
  LEASE_INTEREST_RATE
  PENALTY_RATE
  PENALTY_CONSTRUCTION_DELAY
  GRADE_FACTOR_MULTIPLIER
  ANNUAL_ESCALATION_RATE
  DOWN_PAYMENT_INTEREST
  LATE_PAYMENT_GRACE_DAYS
  BANK_REFERENCE_RATE
}

enum SyncStatus {
  PENDING
  SYNCED
  FAILED
  MANUAL
}

enum AuditAction {
  CREATE
  READ
  UPDATE
  DELETE
  LOGIN
  CONFIG_CHANGE
}

enum LeaseStatus {
  ACTIVE
  EXPIRED
  TERMINATED
  DEFAULTED
}

enum ConfigCategory {
  LAND_TENURE
  REVENUE_TYPE
  DOCUMENT_TYPE
  TRANSFER_TYPE
  LAND_USE
  PAYMENT_METHOD
  ENCUMBRANCE_TYPE
  GENERAL
  REVENUE_RATES
  ORDER_NUMBER_FORMAT
}

enum PaymentStatus {
  UNPAID
  PAID
  OVERDUE
}

enum EncumbranceStatus {
  ACTIVE
  RELEASED
}

enum ParcelStatus {
  ACTIVE
  RETIRED
  PENDING
}

enum OrderGenerationMode {
  AUTO
  MANUAL
  BULK
}

enum OrderStatus {
  GENERATED
  PAID
  EXPIRED
  CANCELLED
}

enum TransactionType {
  PAYMENT
  REFUND
  ADJUSTMENT
}
