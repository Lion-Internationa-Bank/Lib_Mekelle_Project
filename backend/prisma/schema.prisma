generator client {
  provider            = "prisma-client"
  output              = "../src/generated/prisma"
  generatedFileExtension = "ts"
  importFileExtension = "ts"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  CITY_ADMIN 
  SUBCITY_ADMIN      
  SUBCITY_NORMAL   
  SUBCITY_AUDITOR  
  REVENUE_ADMIN    
  REVENUE_USER     
}

enum RateType {
  LEASE_INTEREST_RATE
  PENALTY_RATE
  PENALTY_CONSTRUCTION_DELAY
  GRADE_FACTOR_MULTIPLIER
  ANNUAL_ESCALATION_RATE
  DOWN_PAYMENT_INTEREST
  LATE_PAYMENT_GRACE_DAYS
  BANK_REFERENCE_RATE
}

enum SyncStatus {
  PENDING
  SYNCED
  FAILED
  MANUAL
}

enum AuditAction {
  CREATE
  READ
  UPDATE
  DELETE
  LOGIN
  CONFIG_CHANGE
}

enum LeaseStatus {
  ACTIVE
  EXPIRED
  TERMINATED
  DEFAULTED
}

// UPDATED ENUM: Added ENCUMBRANCE_TYPE category
enum ConfigCategory {
  LAND_TENURE         // tenure_type
  REVENUE_TYPE        // bill_type, revenue_type
  DOCUMENT_TYPE       // doc_type
  TRANSFER_TYPE       // transfer_type
  LAND_USE            // land_use, usage_type
  PAYMENT_METHOD      // payment_method
  ENCUMBRANCE_TYPE    // NEW: For encumbrances.type
  GENERAL             
  REVENUE_RATES       
}


model rate_configurations {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  rate_type       RateType
  value           Decimal   @db.Decimal(12, 6)
  source          String?
  effective_from  DateTime  @db.Timestamptz // When this rate becomes active
  effective_until DateTime? @db.Timestamptz // When this rate expires (null = current/indefinite)
  created_at      DateTime  @default(now()) @db.Timestamptz
  updated_at      DateTime  @updatedAt @db.Timestamptz
  created_by      String?   @db.Uuid
  is_active       Boolean   @default(true)

  @@unique([rate_type, effective_from])
  @@index([rate_type, effective_from, effective_until])
  @@index([rate_type, is_active])
}
model sub_cities {       
  sub_city_id   String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name          String         @unique @db.VarChar(100)
  description   String?
  created_at    DateTime       @default(now())
  updated_at    DateTime       @updatedAt
  deleted_at    DateTime?
  is_deleted    Boolean        @default(false)

  land_parcels  land_parcels[]
  users         users[]
}

model users {
  user_id       String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  username      String         @unique @db.VarChar(100)
  email         String?        @unique @db.VarChar(255)
  password_hash String         
  full_name     String
  role          UserRole
  sub_city_id   String?        @db.Uuid  
  created_at    DateTime       @default(now())
  updated_at    DateTime       @updatedAt
  last_login    DateTime?
  is_active     Boolean        @default(true)
  deleted_at    DateTime?
  is_deleted    Boolean        @default(false)

  sub_city      sub_cities?    @relation(fields: [sub_city_id], references: [sub_city_id])
  audit_logs    audit_logs[]
}

model configurations {
  config_id     String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  key           String         @unique @db.VarChar(100)  
  value         Json           
  category      ConfigCategory?
  description   String?
  is_active     Boolean        @default(true)
  created_at    DateTime       @default(now())
  updated_at    DateTime       @updatedAt
  deleted_at    DateTime?
  is_deleted    Boolean        @default(false)
}

model audit_logs {
  log_id        String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id       String         @db.Uuid
  action_type   AuditAction
  entity_type   String         
  entity_id     String
  changes       Json?          
  timestamp     DateTime       @default(now())
  ip_address    String?

  user          users          @relation(fields: [user_id], references: [user_id])
}

model land_parcels {
  upin              String         @id @db.VarChar(50)
  file_number       String         @unique @db.VarChar(100)
  sub_city_id       String         @db.Uuid       
  tabia             String         @db.VarChar(100)
  ketena            String         @db.VarChar(50)
  block             String         @db.VarChar(50)
  total_area_m2     Decimal        @db.Decimal(12, 2)
  land_use          String?                       // Validate against ConfigCategory.LAND_USE
  land_grade        Decimal        @db.Decimal(10, 2)
  tenure_type       String         @default("OLD_POSSESSION")  // Validate against ConfigCategory.LAND_TENURE
   parent_upin       String?        @db.VarChar(50)
   status            ParcelStatus   @default(ACTIVE)
  boundary_coords   Json?
  boundary_north    String?        @db.VarChar(255) 
  boundary_east     String?        @db.VarChar(255)
  boundary_south    String?        @db.VarChar(255)
  boundary_west     String?        @db.VarChar(255)
  created_at        DateTime       @default(now())
  updated_at        DateTime       @updatedAt
  deleted_at        DateTime?
  is_deleted        Boolean        @default(false)

  parent_parcel     land_parcels?  @relation("ParcelLineage", fields: [parent_upin], references: [upin])
  child_parcels     land_parcels[] @relation("ParcelLineage")
  billing_records   billing_records[]
  buildings         building_details[]
  documents         documents[]
  encumbrances      encumbrances[]
  transactions      financial_transactions[]
  lease_agreement   lease_agreements?
  history           ownership_history[]
  owners            parcel_owners[]
  valuations        tax_valuation_roll[]
  sub_city          sub_cities     @relation(fields: [sub_city_id], references: [sub_city_id])

  @@index([sub_city_id, tabia])
  @@index([status])
}

model owners {
  owner_id          String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  full_name         String
  national_id       String         @unique @db.VarChar(50)
  tin_number        String?        @unique @db.VarChar(50)
  phone_number      String
  created_at        DateTime?      @default(now())
  updated_at        DateTime?      @updatedAt
  deleted_at        DateTime?
  is_deleted        Boolean        @default(false)

  documents         documents[]
  parcels           parcel_owners[]
  transferred_from  ownership_history[] @relation("OwnershipHistoryFrom")
  transferred_to    ownership_history[] @relation("OwnershipHistoryTo")
}

model parcel_owners {
  upin              String         @db.VarChar(50)
  owner_id          String         @db.Uuid
  created_at        DateTime       @default(now())
  updated_at        DateTime       @updatedAt
  acquired_at       DateTime       @default(now())
  is_active         Boolean        @default(true)
  retired_at        DateTime?
  parcel_owner_id   String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  deleted_at        DateTime?
  is_deleted        Boolean        @default(false)

  owner             owners         @relation(fields: [owner_id], references: [owner_id], onDelete: Cascade)
  parcel            land_parcels   @relation(fields: [upin], references: [upin], onDelete: Cascade)

  @@unique([upin, owner_id, acquired_at])
}

model ownership_history {
  history_id        String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  upin              String
  event_snapshot    Json
  transfer_type     String                                      // Validate against ConfigCategory.TRANSFER_TYPE
  transfer_date     DateTime       @default(now())
  created_at        DateTime       @default(now())
  updated_at        DateTime?      @updatedAt
  from_owner_id     String?        @db.Uuid
  reference_no      String?        @unique
  to_owner_id       String?        @db.Uuid
  transfer_price    Decimal?       @db.Decimal(18, 2)
  deleted_at        DateTime?
  is_deleted        Boolean        @default(false)

  documents         documents[]
  from_owner        owners?        @relation("OwnershipHistoryFrom", fields: [from_owner_id], references: [owner_id])
  to_owner          owners?        @relation("OwnershipHistoryTo", fields: [to_owner_id], references: [owner_id])
  parcel            land_parcels   @relation(fields: [upin], references: [upin])

  @@index([upin])
}

model lease_agreements {
  lease_id             String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  upin                 String         @unique @db.VarChar(50)
  annual_lease_fee     Decimal?        @db.Decimal(18, 2)
  total_lease_amount   Decimal        @db.Decimal(18, 2)
  start_date           DateTime       @db.Date
  expiry_date          DateTime?       @db.Date
  annual_installment   Decimal        @db.Decimal(18, 2)
  contract_date        DateTime       @db.Date
  created_at           DateTime       @default(now())
  down_payment_amount  Decimal        @db.Decimal(18, 2)
  lease_period_years   Int
  legal_framework      String
  payment_term_years   Int
  status               LeaseStatus    @default(ACTIVE)
  price_per_m2         Decimal        @db.Decimal(18, 2)
  interest_rate        Decimal?       @db.Decimal(5, 4)  
  updated_at           DateTime?      @updatedAt
  deleted_at           DateTime?
  is_deleted           Boolean        @default(false)

  documents            documents[]
  land_parcel          land_parcels   @relation(fields: [upin], references: [upin])
  billing_records billing_records[]
}

model building_details {
  building_id   String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  upin          String         @db.VarChar(50)
  usage_type    String?                       // Can validate against LAND_USE config if needed
  total_area    Decimal        @db.Decimal(12, 2)
  floor_count   Int            @default(0)
  created_at    DateTime       @default(now())
  updated_at    DateTime?      @updatedAt
  deleted_at    DateTime?
  is_deleted    Boolean        @default(false)

  parcel        land_parcels   @relation(fields: [upin], references: [upin])
}

model billing_records {
  bill_id           String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  upin              String         @db.VarChar(50)
  lease_id           String?       @db.Uuid
  fiscal_year       Int
  bill_type         String                                      // Validate against ConfigCategory.REVENUE_TYPE
  amount_due        Decimal        @db.Decimal(18, 2)
  amount_paid       Decimal        @default(0) @db.Decimal(18, 2)
  penalty_amount    Decimal?        @default(0) @db.Decimal(18, 2)
  interest_amount   Decimal        @default(0) @db.Decimal(18, 2)   
  payment_status    PaymentStatus  @default(UNPAID)             // Native enum
  installment_number Int?
  due_date          DateTime?                              
  bank_reference    String?                                
  last_synced_at    DateTime?  
  sync_status        SyncStatus?   @default(PENDING)
  interest_rate_used Decimal?      @db.Decimal(5, 4)
  penalty_rate_used  Decimal?      @db.Decimal(10, 4)                            
  created_at        DateTime       @default(now())
  updated_at        DateTime?      @updatedAt
  deleted_at        DateTime?
  is_deleted        Boolean        @default(false)

  parcel            land_parcels   @relation(fields: [upin], references: [upin])
  transactions      financial_transactions[]
  lease_agreement lease_agreements?      @relation(fields: [lease_id], references: [lease_id])


@@unique([upin, lease_id,fiscal_year, bill_type,installment_number])

  @@index([fiscal_year])
  @@index([payment_status])
  @@index([upin, fiscal_year])
}

model financial_transactions {
  transaction_id     String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  bill_id            String?        @db.Uuid
  upin               String         @db.VarChar(50)
  revenue_type       String                                      // Validate against ConfigCategory.REVENUE_TYPE
  receipt_serial_no  String         @unique
  amount_paid        Decimal        @db.Decimal(18, 2)
  payment_method     String?                                     // Validate against ConfigCategory.PAYMENT_METHOD
  bank_transaction_id String?     
  bank_branch         String?   
  is_partial          Boolean   @default(false)                       
  payment_date       DateTime       @default(now())
  created_at         DateTime       @default(now())
  updated_at         DateTime?      @updatedAt
  deleted_at         DateTime?
  is_deleted         Boolean        @default(false)

  billing_record     billing_records? @relation(fields: [bill_id], references: [bill_id])
  parcel             land_parcels     @relation(fields: [upin], references: [upin])
}

// UPDATED: encumbrances.type remains String, now validated against new ENCUMBRANCE_TYPE category
model encumbrances {
  encumbrance_id    String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  upin              String         @db.VarChar(50)
  type              String                                      // Validate against ConfigCategory.ENCUMBRANCE_TYPE
  issuing_entity    String
  reference_number  String?
  status            EncumbranceStatus @default(ACTIVE)          // Native enum
  registration_date DateTime       @default(now())
  created_at        DateTime       @default(now())
  updated_at        DateTime?      @updatedAt
  deleted_at        DateTime?
  is_deleted        Boolean        @default(false)

  documents         documents[]
  land_parcel       land_parcels   @relation(fields: [upin], references: [upin], onDelete: Cascade)
}

model tax_valuation_roll {
  valuation_id   String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  upin           String         @db.VarChar(50)
  taxable_value  Decimal        @db.Decimal(18, 2)
  appraisal_date DateTime       @default(now())
  expiry_date    DateTime
  created_at     DateTime       @default(now())
  updated_at     DateTime?      @updatedAt
  deleted_at     DateTime?
  is_deleted     Boolean        @default(false)

  parcel         land_parcels   @relation(fields: [upin], references: [upin])
}

model documents {
  doc_id            String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  upin              String?        @db.VarChar(50)
  owner_id          String?        @db.Uuid
  lease_id          String?        @db.Uuid
  history_id        String?        @db.Uuid
  encumbrance_id    String?        @db.Uuid
  doc_type          String                                      // Validate against ConfigCategory.DOCUMENT_TYPE
  file_url          String
  file_name         String
  is_verified       Boolean        @default(false)
  upload_date       DateTime       @default(now())
  created_at        DateTime       @default(now())
  updated_at        DateTime?      @updatedAt
  deleted_at        DateTime?
  is_deleted        Boolean        @default(false)

  encumbrance       encumbrances?    @relation(fields: [encumbrance_id], references: [encumbrance_id], onDelete: Cascade)
  history           ownership_history? @relation(fields: [history_id], references: [history_id], onDelete: Cascade)
  lease             lease_agreements? @relation(fields: [lease_id], references: [lease_id], onDelete: Cascade)
  owner             owners?          @relation(fields: [owner_id], references: [owner_id], onDelete: Cascade)
  parcel            land_parcels?    @relation(fields: [upin], references: [upin], onDelete: Cascade)
}

// REMAINING NATIVE ENUMS (stable and well-known)
enum PaymentStatus {
  UNPAID
  PARTIAL
  PAID
  OVERDUE
}

enum EncumbranceStatus {
  ACTIVE
  RELEASED
}

enum ParcelStatus {
  ACTIVE    
  RETIRED   
  PENDING  
}
