generator client {
  provider               = "prisma-client"
  output                 = "../src/generated/prisma"
  generatedFileExtension = "ts"
  importFileExtension    = "ts"
}

datasource db {
  provider = "postgresql"
}

// Add to your existing schema
model wizard_sessions {
  session_id         String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id            String        @db.Uuid
  user_role          UserRole
  sub_city_id        String?       @db.Uuid
  status             SessionStatus @default(DRAFT)
  
  // Wizard data
  parcel_data        Json?
  parcel_docs        Json?
  owner_data         Json?
  owner_docs         Json?
  lease_data         Json?
  lease_docs         Json?
  
  // Approval workflow
  approval_request_id String?      @db.Uuid
  current_step       String        @default("parcel")
  
  // Timestamps
  completed_at       DateTime?
  created_at         DateTime      @default(now()) @db.Timestamptz(6)
  updated_at         DateTime      @updatedAt @db.Timestamptz(6)
  submitted_at       DateTime?
  expires_at         DateTime      @default(dbgenerated("(now() + '24 hours'::interval)")) @db.Timestamptz(6)
  
  // Relationships
  user               users         @relation(fields: [user_id], references: [user_id])

  sub_city           sub_cities?   @relation(fields: [sub_city_id], references: [sub_city_id])
  approval_request   approval_requests? @relation(fields: [approval_request_id], references: [request_id])
  wizard_documents_temps  wizard_documents_temp[]
  @@unique([approval_request_id])
  @@index([user_id, status])
  @@index([sub_city_id, status])
  @@index([expires_at])
  @@index([approval_request_id])
}

model wizard_documents_temp {
  id                 String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  session_id         String        @db.Uuid
  step               String        // parcel-docs, owner-docs, lease-docs
  document_type      String
  file_name          String
  file_url           String        // Temporary URL
  file_size          Int
  mime_type          String
  metadata           Json?
  expires_at         DateTime
  created_at         DateTime      @default(now())
  
  session            wizard_sessions @relation(fields: [session_id], references: [session_id])
  
  @@index([session_id])
  @@index([expires_at])
}

model approval_requests {
  request_id        String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  entity_type       EntityType
  entity_id         String         @db.VarChar(255)
  action_type       ActionType      
  request_data      Json
  status            RequestStatus  @default(PENDING)
  maker_id          String         @db.Uuid
  maker_role        UserRole
  approver_role     UserRole
  sub_city_id       String?        @db.Uuid
  rejection_reason  String?
  created_at        DateTime       @default(now()) @db.Timestamptz(6)
  updated_at        DateTime       @updatedAt @db.Timestamptz(6)
  approved_at       DateTime?
  comments          String?
  rejected_at       DateTime?
  deleted_at        DateTime?
  is_deleted        Boolean        @default(false)
  
  maker             users          @relation(fields: [maker_id], references: [user_id])
  sub_city          sub_cities?    @relation(fields: [sub_city_id], references: [sub_city_id])
  approval_logs     approval_logs[]
  wizard_session    wizard_sessions?

  @@index([maker_id])
  @@index([status])
  @@index([entity_type, entity_id])
  @@index([sub_city_id, status])
  @@index([approver_role, status])
}

model approval_logs {
  log_id            String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  request_id        String           @db.Uuid
  action            ApprovalAction
  performed_by      String           @db.Uuid
  performed_by_role UserRole
  comments          String?
  previous_status   RequestStatus?
  new_status        RequestStatus?
  created_at        DateTime         @default(now()) @db.Timestamptz(6)
  
  request           approval_requests @relation(fields: [request_id], references: [request_id])
  user              users             @relation(fields: [performed_by], references: [user_id])
  
  @@index([request_id])
  @@index([performed_by])
}



// Add these enums
enum SessionStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  REJECTED
  EXPIRED
  MERGED
  FAILED
}

enum EntityType{
  WIZARD_SESSION
  LAND_PARCELS
  OWNERS
  LEASE_AGREEMENTS
  ENCUMBRANCES
  APPROVAL_REQUEST
}


enum ActionType {
  CREATE
  UPDATE
  DELETE
  TRANSFER
  SUBDIVIDE
  MERGE
  TERMINATE
  EXTEND
  ADD_OWNER
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
  RETURNED
  CANCELLED
  FAILED
}


enum ApprovalAction {
  CREATE
  APPROVE
  REJECT
  RETURN
  COMMENT
}


model rate_configurations {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  rate_type       RateType
  value           Decimal   @db.Decimal(12, 6)
  source          String?
  effective_from  DateTime  @db.Timestamptz(6)
  effective_until DateTime? @db.Timestamptz(6)
  created_at      DateTime  @default(now()) @db.Timestamptz(6)
  updated_at      DateTime  @updatedAt @db.Timestamptz(6)
  created_by      String?   @db.Uuid
  is_active       Boolean   @default(true)

  @@unique([rate_type, effective_from])
  @@index([rate_type, effective_from, effective_until])
  @@index([rate_type, is_active])
}

model sub_cities {
  sub_city_id  String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name         String         @unique @db.VarChar(100)
  description  String?
  created_at   DateTime       @default(now())
  updated_at   DateTime       @updatedAt
  deleted_at   DateTime?
  is_deleted   Boolean        @default(false)
  land_parcels land_parcels[]
  users        users[]
  owners       owners[]
  wizard_sessions wizard_sessions[]
  approval_requests approval_requests[]
}

model users {
  user_id       String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  username      String       @unique @db.VarChar(100)
  email         String?      @unique @db.VarChar(255)
  password_hash String
  full_name     String
  role          UserRole
  sub_city_id   String?      @db.Uuid
  created_at    DateTime     @default(now())
  updated_at    DateTime     @updatedAt
  last_login    DateTime?
  is_active     Boolean      @default(true)
  deleted_at    DateTime?
  is_deleted    Boolean      @default(false)
  audit_logs    audit_logs[]
  approval_logs approval_logs[]
  wizard_sessions wizard_sessions[]
  approval_requests approval_requests[]
  documents         documents[]
  sub_city      sub_cities?  @relation(fields: [sub_city_id], references: [sub_city_id])
}

model configurations {
  config_id   String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  key         String          @unique @db.VarChar(100)
  value       Json
  category    ConfigCategory?
  description String?
  is_active   Boolean         @default(true)
  created_at  DateTime        @default(now())
  updated_at  DateTime        @updatedAt
  deleted_at  DateTime?
  is_deleted  Boolean         @default(false)
}

model audit_logs {
  log_id      String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id     String      @db.Uuid
  action_type AuditAction
  entity_type String
  entity_id   String?
  changes     Json?
  timestamp   DateTime    @default(now())
  ip_address  String?
  deleted_at  DateTime?
  is_deleted  Boolean     @default(false)
  user        users       @relation(fields: [user_id], references: [user_id])

  @@index([timestamp])
  @@index([user_id, action_type])
  @@index([entity_type, entity_id])
}

model land_parcels {
  upin             String                   @id @db.VarChar(50)
  file_number      String                   @unique @db.VarChar(100)
  tabia            String                   @db.VarChar(100)
  ketena           String                   @db.VarChar(50)
  block            String                   @db.VarChar(50)
  total_area_m2    Decimal                  @db.Decimal(12, 2)
  land_use         String?
  created_at       DateTime                 @default(now())
  updated_at       DateTime                 @updatedAt
  deleted_at       DateTime?
  is_deleted       Boolean                  @default(false)
  land_grade       Decimal                  @db.Decimal(10, 2)
  sub_city_id      String                   @db.Uuid
  tenure_type      String                   @default("OLD_POSSESSION")
  boundary_coords  Json?
  boundary_east    String?                  @db.VarChar(255)
  boundary_north   String?                  @db.VarChar(255)
  boundary_south   String?                  @db.VarChar(255)
  boundary_west    String?                  @db.VarChar(255)
  parent_upin      String?                  @db.VarChar(50)
  status           ParcelStatus             @default(ACTIVE)
  billing_records  billing_records[]
  buildings        building_details[]
  documents        documents[]
  encumbrances     encumbrances[]
  transactions     financial_transactions[]
  parent_parcel    land_parcels?            @relation("ParcelLineage", fields: [parent_upin], references: [upin])
  child_parcels    land_parcels[]           @relation("ParcelLineage")
  sub_city         sub_cities               @relation(fields: [sub_city_id], references: [sub_city_id])
  lease_agreement  lease_agreements?
  history          ownership_history[]
  owners           parcel_owners[]
  valuations       tax_valuation_roll[]

  @@index([sub_city_id, tabia])
  @@index([status])
}

model owners {
  owner_id         String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  full_name        String
  national_id      String              @unique @db.VarChar(50)
  tin_number       String?             @unique @db.VarChar(50)
  sub_city_id      String              @db.Uuid
  phone_number     String
  created_at       DateTime?           @default(now())
  updated_at       DateTime?           @updatedAt
  deleted_at       DateTime?
  is_deleted       Boolean             @default(false)
  documents        documents[]
  transferred_from ownership_history[] @relation("OwnershipHistoryFrom")
  transferred_to   ownership_history[] @relation("OwnershipHistoryTo")
  parcels          parcel_owners[]
  sub_city         sub_cities   @relation(fields:[sub_city_id],references:[sub_city_id])
}

model parcel_owners {
  upin            String       @db.VarChar(50)
  owner_id        String       @db.Uuid
  created_at      DateTime     @default(now())
  updated_at      DateTime     @updatedAt
  acquired_at     DateTime     @default(now())
  is_active       Boolean      @default(true)
  retired_at      DateTime?
  parcel_owner_id String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  deleted_at      DateTime?
  is_deleted      Boolean      @default(false)
  owner           owners       @relation(fields: [owner_id], references: [owner_id], onDelete: Cascade)
  parcel          land_parcels @relation(fields: [upin], references: [upin], onDelete: Cascade)

  @@unique([upin, owner_id, acquired_at])
}

model ownership_history {
  history_id     String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  upin           String
  event_snapshot Json
  transfer_date  DateTime     @default(now())
  created_at     DateTime     @default(now())
  updated_at     DateTime?    @updatedAt
  from_owner_id  String?      @db.Uuid
  reference_no   String?      @unique
  to_owner_id    String?      @db.Uuid
  transfer_price Decimal?     @db.Decimal(18, 2)
  deleted_at     DateTime?
  is_deleted     Boolean      @default(false)
  transfer_type  String
  documents      documents[]
  from_owner     owners?      @relation("OwnershipHistoryFrom", fields: [from_owner_id], references: [owner_id])
  to_owner       owners?      @relation("OwnershipHistoryTo", fields: [to_owner_id], references: [owner_id])
  parcel         land_parcels @relation(fields: [upin], references: [upin])

  @@index([upin])
}

model lease_agreements {
  lease_id            String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  upin                String            @unique @db.VarChar(50)
  annual_lease_fee    Decimal?          @db.Decimal(18, 2)
  total_lease_amount  Decimal           @db.Decimal(18, 2)
  start_date          DateTime          @db.Date
  expiry_date         DateTime?         @db.Date
  annual_installment  Decimal           @db.Decimal(18, 2)
  contract_date       DateTime          @db.Date
  created_at          DateTime          @default(now())
  down_payment_amount Decimal           @db.Decimal(18, 2)

  demarcation_fee        Decimal?         @db.Decimal(18, 2) 
  contract_registration_fee Decimal?            @db.Decimal(18, 2)
  engineering_service_fee  Decimal?         @db.Decimal(18, 2)
  lease_period_years  Int
  legal_framework     String
  payment_term_years  Int
  price_per_m2        Decimal           @db.Decimal(18, 2)
  updated_at          DateTime?         @updatedAt
  deleted_at          DateTime?
  is_deleted          Boolean           @default(false)
  interest_rate       Decimal?          @db.Decimal(5, 4)
  status              LeaseStatus       @default(ACTIVE)
  other_payment       Decimal?          @db.Decimal(18, 2)
  billing_records     billing_records[]
  documents           documents[]
  land_parcel         land_parcels      @relation(fields: [upin], references: [upin])
}

model building_details {
  building_id String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  upin        String       @db.VarChar(50)
  usage_type  String?
  total_area  Decimal      @db.Decimal(12, 2)
  floor_count Int          @default(0)
  created_at  DateTime     @default(now())
  updated_at  DateTime?    @updatedAt
  deleted_at  DateTime?
  is_deleted  Boolean      @default(false)
  parcel      land_parcels @relation(fields: [upin], references: [upin])
}

model billing_records {
  bill_id            String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  upin               String             @db.VarChar(50)
  fiscal_year        Int
  amount_due         Decimal            @db.Decimal(18, 2)
  penalty_amount     Decimal?           @default(0) @db.Decimal(18, 2)
  payment_status     PaymentStatus      @default(UNPAID)
  created_at         DateTime           @default(now())
  updated_at         DateTime?          @updatedAt
  deleted_at         DateTime?
  is_deleted         Boolean            @default(false)
  due_date           DateTime?
  interest_amount    Decimal            @default(0) @db.Decimal(18, 2)
  bill_type          String
  interest_rate_used Decimal?           @db.Decimal(5, 4)
  lease_id           String?            @db.Uuid
  penalty_rate_used  Decimal?           @db.Decimal(10, 4)
  sync_status        SyncStatus?        @default(PENDING)
  installment_number Int?
  base_payment       Decimal?           @db.Decimal(18, 2)
  remaining_amount   Decimal?           @default(0) @db.Decimal(18, 2)
  last_payment_date  DateTime?
  amount_paid        Decimal            @db.Decimal(18, 2)
  lease_agreement    lease_agreements?  @relation(fields: [lease_id], references: [lease_id])
  parcel             land_parcels       @relation(fields: [upin], references: [upin])

  @@unique([upin, lease_id, fiscal_year, bill_type, installment_number])
  @@index([fiscal_year])
  @@index([payment_status])
  @@index([upin, fiscal_year])
  @@index([due_date])
}

model financial_transactions {
  transaction_id      String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  upin                String          @db.VarChar(50)
  amount_paid         Decimal         @db.Decimal(18, 2)
  payment_date        DateTime        @default(now())
  created_at          DateTime        @default(now())
  updated_at          DateTime?       @updatedAt
  deleted_at          DateTime?
  is_deleted          Boolean         @default(false)
  bank_transaction_id String?
  payment_type        String
  bank_branch         String?
  bank_account        String?
  notes               String?
  recorded_at         DateTime        @default(now())
  transaction_type    String          @default("PAYMENT")
  parcel              land_parcels    @relation(fields: [upin], references: [upin])

  @@index([bank_transaction_id])
  @@index([payment_date])
  @@index([upin, payment_date])
}

model encumbrances {
  encumbrance_id    String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  upin              String            @db.VarChar(50)
  issuing_entity    String
  reference_number  String?
  status            EncumbranceStatus @default(ACTIVE)
  registration_date DateTime          @default(now())
  created_at        DateTime          @default(now())
  updated_at        DateTime?         @updatedAt
  deleted_at        DateTime?
  is_deleted        Boolean           @default(false)
  type              String
  documents         documents[]
  land_parcel       land_parcels      @relation(fields: [upin], references: [upin], onDelete: Cascade)
}

model tax_valuation_roll {
  valuation_id   String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  upin           String       @db.VarChar(50)
  taxable_value  Decimal      @db.Decimal(18, 2)
  appraisal_date DateTime     @default(now())
  expiry_date    DateTime
  created_at     DateTime     @default(now())
  updated_at     DateTime?    @updatedAt
  deleted_at     DateTime?
  is_deleted     Boolean      @default(false)
  parcel         land_parcels @relation(fields: [upin], references: [upin])
}

model documents {
  doc_id         String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  upin           String?            @db.VarChar(50)
  owner_id       String?            @db.Uuid
  file_url       String
  file_name      String
  is_verified    Boolean            @default(false)
  upload_date    DateTime           @default(now())
  created_at     DateTime           @default(now())
  updated_at     DateTime?          @updatedAt
  lease_id       String?            @db.Uuid
  history_id     String?            @db.Uuid
  encumbrance_id String?            @db.Uuid
  deleted_at     DateTime?
  is_deleted     Boolean            @default(false)
  doc_type       String
  verified_by    String?            @db.Uuid
  encumbrance    encumbrances?      @relation(fields: [encumbrance_id], references: [encumbrance_id], onDelete: Cascade)
  history        ownership_history? @relation(fields: [history_id], references: [history_id], onDelete: Cascade)
  lease          lease_agreements?  @relation(fields: [lease_id], references: [lease_id], onDelete: Cascade)
  owner          owners?            @relation(fields: [owner_id], references: [owner_id], onDelete: Cascade)
  user           users?             @relation(fields: [verified_by], references: [user_id], onDelete: Cascade)
  parcel         land_parcels?      @relation(fields: [upin], references: [upin], onDelete: Cascade)
}



enum UserRole {
  CITY_ADMIN
  SUBCITY_NORMAL
  SUBCITY_AUDITOR
  REVENUE_ADMIN
  REVENUE_USER
  SUBCITY_ADMIN
}

enum RateType {
  LEASE_INTEREST_RATE
  PENALTY_RATE
  PENALTY_CONSTRUCTION_DELAY
  GRADE_FACTOR_MULTIPLIER
  ANNUAL_ESCALATION_RATE
  DOWN_PAYMENT_INTEREST
  LATE_PAYMENT_GRACE_DAYS
  BANK_REFERENCE_RATE
}

enum SyncStatus {
  PENDING
  SYNCED
  FAILED
  MANUAL
}

enum AuditAction {
  CREATE
  READ
  UPDATE
  DELETE
  LOGIN
  CONFIG_CHANGE
}

enum LeaseStatus {
  ACTIVE
  EXPIRED
  TERMINATED
  DEFAULTED
}

enum ConfigCategory {
  LAND_TENURE
  REVENUE_TYPE
  DOCUMENT_TYPE
  TRANSFER_TYPE
  LAND_USE
  PAYMENT_METHOD
  ENCUMBRANCE_TYPE
  GENERAL
  REVENUE_RATES
  ORDER_NUMBER_FORMAT
}

enum PaymentStatus {
  UNPAID
  PAID
  OVERDUE
}

enum OrderStatus {
  GENERATED
  PAID
  EXPIRED
  CANCELLED
}

enum OrderGenerationMode {
  AUTO
  MANUAL
  BULK
}

enum TransactionType {
  PAYMENT
  REFUND
  ADJUSTMENT
}

enum EncumbranceStatus {
  ACTIVE
  RELEASED
}

enum ParcelStatus {
  ACTIVE
  RETIRED
  PENDING
}
